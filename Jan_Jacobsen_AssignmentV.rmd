---
title: "DSPM Assignment 05"
author: "Jan Jacobsen"
date: "1/11/2022"
output: 
  html_document:
    toc: true
---


```{r setup}
# set default options for code chunks
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# set working directory
my_path <- r"{E:\R\DSPM_Assignment_05\}"
knitr::opts_knit$set(root.dir = my_path)

# clear workspace
rm(list = ls())


# include api storage file 
source("api_key_storage.r") 

# if you are not the creator: set your own API key instead using the following line
# api_key <- "your key"
```


```{r}
# imports
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("jsonlite")) install.packages("jsonlite")
if (!require("httr")) install.packages("httr")
library(tidyverse)
library(jsonlite)
library(httr)
```



```{r api_basics}
# retrieve german venue data (without specifiying page)
response_1_raw <- 
  GET(
    url = "https://app.ticketmaster.com/discovery/v2/venues?",
    query = list(countryCode = "DE",
              locale = "*",
              apikey = api_key)
  )
       
# get R list from response content json
response_1 <- jsonlite::fromJSON(content(response_1_raw, as = "text"))

# extract venue data from response
df <- response_1[["_embedded"]][["venues"]]

# build dataframe with required variables from retrieved data
venue_df_1 <- data.frame(
                name = df$name,
                city = df$city$name, 
                postalCode = df$postalCode,
                address = df$address$line1,
                url = df$url,
                long = as.double(df$location$longitude),
                lat = as.double(df$location$latitude),
                stringsAsFactors = FALSE
                )

glimpse(venue_df_1)
```

```{r api_advanced}
# get number of pages to loop through (should be 629)
total_pages <- response_1$page$totalPages

# pages start at zero
start_page <- 0

# define dataframe to contain the entire dataset (same structure as in previous task)
df_venue_data2 <- 
  data.frame(
    name = character(),
    city = character(),
    postalCode = character(),
    address = character(),
    url = character(),
    long = double(),
    lat = double(),
    stringsAsFactors = FALSE
)

# loop through pages
for (p in start_page:(total_pages-1)){
  
# retrieve german venue data (without specifiying page)
response_2_raw <- 
  GET(
    url = "https://app.ticketmaster.com/discovery/v2/venues?",
    query = list(countryCode = "DE",
              locale = "*",
              page = as.character(p), # current page
              apikey = api_key)
  )
       
# get R list from response content json
response_2 <- jsonlite::fromJSON(content(response_2_raw, as = "text"))

# extract venue data from response
df <- response_2[["_embedded"]][["venues"]]

# build (interim) df with required variables from retrieved data
single_page_df <- data.frame(
                    name = df$name,
                    city = df$city$name, 
                    postalCode = df$postalCode,
                    address = df$address$line1,
                    url = df$url,
                    long = as.double(df$location$longitude),
                    lat = as.double(df$location$latitude),
                    stringsAsFactors = FALSE
                  )

# append to main df
df_venue_data2 <- df_venue_data2 %>% bind_rows(single_page_df)

# delay to comply with API restrictions 
# minimum 0.2 seconds between requests is required according to ticketmaster, 
# but values slightly above this limit seem to get throttled anyways before all 
# pages are finished. The exact restriction policy is unclear.)
Sys.sleep(0.5) 

# print progress to console
print(paste0("page ", as.character(p), " data retrieved"))
}

```

